import{BehaviorSubject as e,Subject as t,AsyncSubject as s}from"rxjs";import{first as i}from"rxjs/operators";import{Color as o,MeshPhysicalMaterial as r,NormalBlending as n,DoubleSide as h,WebGLRenderTarget as a,Scene as l,DirectionalLight as d,Mesh as c,MeshStandardMaterial as g,NoBlending as u,PerspectiveCamera as m,Box3 as _,Vector3 as p,AmbientLight as M,HemisphereLight as y,WebGLRenderer as f,sRGBEncoding as C,NoToneMapping as v,Uint32BufferAttribute as S,Float32BufferAttribute as w,BufferGeometry as b}from"three";import{GLTFLoader as E}from"three/examples/jsm/loaders/GLTFLoader";import{DRACOLoader as L}from"three/examples/jsm/loaders/DRACOLoader";import{ResizeSensor as I}from"css-element-queries";import{OrbitControls as P}from"three/examples/jsm/controls/OrbitControls";class x{static get default(){return{downX:null,downY:null,maxDiff:10,mouseMoveTimer:null,waitForDouble:!1}}}class A{constructor(e,t,s,i,o,r){this.r=e,this.g=t,this.b=s,this.roughness=i,this.metalness=o,this.opacity=r}static createFromMaterial(e){return new A(e.color.r,e.color.g,e.color.b,e.roughness,e.metalness,e.opacity)}static deleteFromMesh(e,t=!1,s=!1){e[A.prop]=null,t&&(e[A.customProp]=null),s&&(e[A.defaultProp]=null)}static getDefaultFromMesh(e){return e[A.defaultProp]||(e[A.defaultProp]=A.createFromMaterial(e.material)),e[A.defaultProp]}static getCustomFromMesh(e){return e[A.customProp]}static getFromMesh(e){return e[A.prop]?e[A.prop]:e[A.customProp]?e[A.customProp]:A.getDefaultFromMesh(e)}static setCustomToMesh(e,t){e[A.customProp]=t}static setToMesh(e,t){e[A.prop]=t}toString(){return`${this.r}|${this.g}|${this.b}|${this.roughness}|${this.metalness}|${this.opacity}`}}A.prop="rgbrmo",A.customProp="rgbrmoC",A.defaultProp="rgbrmoD";class B{constructor(e){this._materials=new Map;const{isolationColor:t,isolationOpacity:s,selectionColor:i,highlightColor:r}=e;this._isolationColor=this.buildIsolationColor(t,s),this._selectionColor=new o(i),this._highlightColor=new o(r),this.globalMaterial=this.buildGlobalMaterial()}destroy(){this._materials.forEach(e=>e.dispose()),this._materials=null,this.globalMaterial.dispose(),this.globalMaterial=null}refreshMeshColors(e){e.userData.isolated||A.deleteFromMesh(e);const t=A.getFromMesh(e);let s;return s=e.userData.highlighted?new A(this._highlightColor.r,this._highlightColor.g,this._highlightColor.b,t.roughness,t.metalness,t.opacity):e.userData.selected?new A(this._selectionColor.r,this._selectionColor.g,this._selectionColor.b,t.roughness,t.metalness,t.opacity):e.userData.isolated?this._isolationColor:t,A.setToMesh(e,s),{rgbRmo:s,opacityChanged:s.opacity!==t.opacity}}getMaterial(e){const t=e.toString();if(this._materials.has(t))return this._materials.get(t);const s=this.buildMaterial(e);return this._materials.set(t,s),s}buildIsolationColor(e,t){const s=new o(e);return new A(s.r,s.g,s.b,1,0,t)}buildGlobalMaterial(){const e=new r({vertexColors:!0,flatShading:!0,blending:n,side:h,transparent:!0});return e.onBeforeCompile=e=>{e.vertexShader="\n        attribute vec3 rmo;        \n        varying float roughness;\n        varying float metalness;\n        varying float opacity;\n        "+e.vertexShader,e.vertexShader=e.vertexShader.replace("void main() {","\n        void main() {\n          roughness = rmo.x;\n          metalness = rmo.y;\n          opacity = rmo.z;\n        "),e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","varying float roughness;"),e.fragmentShader=e.fragmentShader.replace("uniform float metalness;","varying float metalness;"),e.fragmentShader=e.fragmentShader.replace("uniform float opacity;","varying float opacity;")},e}buildMaterial(e){return new r({blending:n,side:h,flatShading:!0,color:new o(e.r,e.g,e.b),transparent:1!==e.opacity,roughness:e.roughness,metalness:e.metalness,opacity:e.opacity})}}class R{constructor(){this._lastPickingColor=0,this._materials=[],this._releasedMaterials=[],this._pickingMeshById=new Map,this._sourceMeshByPickingColor=new Map;const e=new a(1,1),t=new l;t.background=new o(0);const s=new d(16777215,1);s.position.set(-1,2,4),this._scene=t,this._target=e,this._cameraLight=s}destroy(){this._materials.forEach(e=>e.dispose()),this._materials=null,this._target.dispose(),this._target=null}add(e){const t=this.getMaterial(),s=t.color.getHex().toString(16),i=new c(e.geometry,t);i.userData.originalUuid=e.uuid,i.userData.color=s,i.position.copy(e.position),i.rotation.copy(e.rotation),i.scale.copy(e.scale),this._scene.add(i),this._pickingMeshById.set(e.uuid,i),this._sourceMeshByPickingColor.set(s,e)}remove(e){const t=this._pickingMeshById.get(e.uuid);t&&(this._scene.remove(t),this._pickingMeshById.delete(e.uuid),this._sourceMeshByPickingColor.delete(t.userData.color),this.releaseMaterial(t.material))}getMeshAt(e,t,s,i){const o=t.domElement.getBoundingClientRect(),r=(s-o.left)*t.domElement.width/o.width,n=(i-o.top)*t.domElement.height/o.height,h=t.getPixelRatio();e.setViewOffset(t.getContext().drawingBufferWidth,t.getContext().drawingBufferHeight,r*h||0,n*h||0,1,1),e.add(this._cameraLight),t.setRenderTarget(this._target),t.render(this._scene,e),t.setRenderTarget(null),e.clearViewOffset(),e.remove(this._cameraLight);const a=new Uint8Array(4);t.readRenderTargetPixels(this._target,0,0,1,1,a);const l=(a[0]<<16|a[1]<<8|a[2]).toString(16);return this._sourceMeshByPickingColor.get(l)}nextPickingColor(){return 16777215===this._lastPickingColor&&(this._lastPickingColor=0),++this._lastPickingColor}getMaterial(){if(this._releasedMaterials.length)return this._releasedMaterials.pop();const e=new o(this.nextPickingColor()),t=new g({color:e,emissive:e,flatShading:!0,blending:u,side:h,roughness:1,metalness:0});return this._materials.push(t),t}releaseMaterial(e){this._releasedMaterials.push(e)}}class D{constructor(e,t){const s=new m(75,1,1,1e4),i=new P(s,e);i.addEventListener("change",t),s.position.set(0,1e3,1e3),s.lookAt(0,0,0),i.update(),this._camera=s,this._orbitControls=i}get camera(){return this._camera}destroy(){this._orbitControls.dispose()}resize(e,t){this._camera&&(this._camera.aspect=e/t,this._camera.updateProjectionMatrix())}focusCameraOnObjects(e,t=1.2){if(!(null==e?void 0:e.length))return;const s=new _;for(const t of e)s.expandByObject(t);const i=s.getSize(new p),o=s.getCenter(new p),r=Math.max(i.x,i.y,i.z)/(2*Math.atan(Math.PI*this._camera.fov/360)),n=r/this._camera.aspect,h=t*Math.max(r,n),a=this._orbitControls.target.clone().sub(this._camera.position).normalize().multiplyScalar(h);this._orbitControls.maxDistance=Math.max(10*h,1e4),this._orbitControls.target.copy(o),this._camera.near=Math.min(h/100,1),this._camera.far=Math.max(100*h,1e4),this._camera.updateProjectionMatrix(),this._camera.position.copy(this._orbitControls.target).sub(a),this._orbitControls.update()}}class G{constructor(e=null){this.dracoDecoderEnabled=!0,this.dracoDecoderPath="/assets/draco/",this.highlightingEnabled=!0,this.highlightColor=16776960,this.selectionColor=16711680,this.isolationColor=5592405,this.isolationOpacity=.2,this.physicalLights=!1,this.ambientLight=!0,this.ambientLightIntensity=1,this.hemiLight=!0,this.hemiLightIntensity=.4,this.dirLight=!0,this.dirLightIntensity=.6,this.useAntialiasing=!0,this.meshMergeType=null,null!=e&&Object.assign(this,e)}}var U=function(e,t,s,i){return new(s||(s=Promise))((function(o,r){function n(e){try{a(i.next(e))}catch(e){r(e)}}function h(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,h)}a((i=i.apply(e,t||[])).next())}))};class F{constructor(s,i){if(this._loadingStateChange=new e(!1),this._modelLoadingStart=new t,this._modelLoadingEnd=new t,this._modelLoadingProgress=new t,this._openedModelsChange=new e([]),this._selectionChange=new e(new Set),this._manualSelectionChange=new t,this._subscriptions=[],this._lights=[],this._renderGeometries=[],this._renderGeometryIndexBySourceMesh=new Map,this._sourceMeshesByRenderGeometryIndex=new Map,this._sourceMeshesNeedColorUpdate=new Set,this._renderGeometryIndicesNeedSort=new Set,this._renderMeshBySourceMesh=new Map,this._pointerEventHelper=x.default,this._queuedColoring=null,this._queuedSelection=null,this._highlightedMesh=null,this._selectedMeshes=[],this._isolatedMeshes=[],this._coloredMeshes=[],this._loadingInProgress=!1,this._loadingQueue=[],this._loadedModels=new Set,this._loadedModelsByGuid=new Map,this._loadedModelsArray=[],this._loadedMeshes=new Set,this._loadedMeshesById=new Map,this._loadedMeshesArray=[],this._onCanvasPointerDown=e=>{this._pointerEventHelper.downX=e.clientX,this._pointerEventHelper.downY=e.clientY},this._onCanvasPointerUp=e=>{const t=e.clientX,s=e.clientY;!this._pointerEventHelper.downX||Math.abs(t-this._pointerEventHelper.downX)>this._pointerEventHelper.maxDiff||Math.abs(s-this._pointerEventHelper.downY)>this._pointerEventHelper.maxDiff||(this._pointerEventHelper.waitForDouble?(this.isolateSelectedMeshes(),this._pointerEventHelper.waitForDouble=!1):(this._pointerEventHelper.waitForDouble=!0,setTimeout(()=>{this._pointerEventHelper.waitForDouble=!1},300),this.selectMeshAtPoint(t,s,e.ctrlKey)),this._pointerEventHelper.downX=null,this._pointerEventHelper.downY=null)},this._onCanvasMouseMove=e=>{e.buttons||(clearTimeout(this._pointerEventHelper.mouseMoveTimer),this._pointerEventHelper.mouseMoveTimer=null,this._pointerEventHelper.mouseMoveTimer=window.setTimeout(()=>{const t=e.clientX,s=e.clientY;this.highlightMeshAtPoint(t,s)},30))},this._container=document.getElementById(s),!this._container)throw new Error("Container not found!");this.init(new G(i))}init(e){this.initObservables(),this._pickingScene=new R,this._colorRgbRmoUtils=new B(e),this.initLights(e),this.initLoader(e),this.initRenderer(e),this._cameraControls=new D(this._renderer.domElement,()=>this.render()),this._containerResizeSensor=new I(this._container,()=>{const{width:e,height:t}=this._container.getBoundingClientRect();this._cameraControls.resize(e,t),this.resizeRenderer(e,t)}),this.addCanvasEventListeners(e),this.render()}destroy(){var e,t,s,i,o,r,n,h,a;this._subscriptions.forEach(e=>e.unsubscribe()),this.closeSubjects(),null===(e=this._containerResizeSensor)||void 0===e||e.detach(),this._containerResizeSensor=null,null===(t=this._cameraControls)||void 0===t||t.destroy(),this._cameraControls=null,null===(s=this._pickingScene)||void 0===s||s.destroy(),this._pickingScene=null,null===(i=this._colorRgbRmoUtils)||void 0===i||i.destroy(),this._colorRgbRmoUtils=null,null===(o=this._loadedMeshes)||void 0===o||o.forEach(e=>{e.geometry.dispose(),e.material.dispose()}),this._loadedMeshes=null,null===(r=this._renderGeometries)||void 0===r||r.forEach(e=>e.geometry.dispose()),this._renderGeometries=null,this._renderScene=null,null===(n=this._renderer)||void 0===n||n.dispose(),null===(a=null===(h=this._loader)||void 0===h?void 0:h.dracoLoader)||void 0===a||a.dispose()}openModelsAsync(e){return U(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.length))return[];const t=[];e.forEach(e=>{const o=new s;this._loadingQueue.push(()=>U(this,void 0,void 0,(function*(){const{url:t,guid:s,name:i}=e,r=this._loadedModelsByGuid.has(s)?{url:t,guid:s}:yield this.loadModel(t,s,i);o.next(r),o.complete()}))),t.push(o.pipe(i()).toPromise())}),this.processLoadingQueueAsync();return yield Promise.all(t)}))}closeModelsAsync(e){return U(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.length))return;const t=[];e.forEach(e=>{const o=new s;this._loadingQueue.push(()=>U(this,void 0,void 0,(function*(){this.removeModelFromLoaded(e),o.next(!0),o.complete()}))),t.push(o.pipe(i()).toPromise())}),this.processLoadingQueueAsync(),yield Promise.all(t)}))}colorItems(e){this._loadingInProgress?this._queuedColoring=e:this.resetSelectionAndColorMeshes(e)}selectItems(e){(null==e?void 0:e.length)&&(this._loadingInProgress?this._queuedSelection={ids:e,isolate:!1}:this.findAndSelectMeshes(e,!1))}isolateItems(e){(null==e?void 0:e.length)&&(this._loadingInProgress?this._queuedSelection={ids:e,isolate:!0}:this.findAndSelectMeshes(e,!0))}getOpenedModels(){return this._openedModelsChange.getValue()}getSelectedItems(){return this._selectionChange.getValue()}initObservables(){this.loadingStateChange$=this._loadingStateChange.asObservable(),this.modelLoadingStart$=this._modelLoadingStart.asObservable(),this.modelLoadingProgress$=this._modelLoadingProgress.asObservable(),this.modelLoadingEnd$=this._modelLoadingEnd.asObservable(),this.openedModelsChange$=this._openedModelsChange.asObservable(),this.selectionChange$=this._selectionChange.asObservable(),this.manualSelectionChange$=this._manualSelectionChange.asObservable()}closeSubjects(){this._loadingStateChange.complete(),this._modelLoadingStart.complete(),this._modelLoadingProgress.complete(),this._modelLoadingEnd.complete(),this._openedModelsChange.complete(),this._selectionChange.complete(),this._manualSelectionChange.complete()}addCanvasEventListeners(e){const{highlightingEnabled:t}=e;this._renderer.domElement.addEventListener("pointerdown",this._onCanvasPointerDown),this._renderer.domElement.addEventListener("pointerup",this._onCanvasPointerUp),t&&this._renderer.domElement.addEventListener("mousemove",this._onCanvasMouseMove)}initLights(e){if(e.ambientLight){const t=new M(2236962,e.physicalLights?e.ambientLightIntensity*Math.PI:e.ambientLightIntensity);this._lights.push(t)}if(e.hemiLight){const t=new y(16777147,526368,e.physicalLights?e.hemiLightIntensity*Math.PI:e.hemiLightIntensity);t.position.set(0,2e3,0),this._lights.push(t)}if(e.dirLight){const t=new d(16777215,e.physicalLights?e.dirLightIntensity*Math.PI:e.dirLightIntensity);t.position.set(-2,10,2),this._lights.push(t)}}initRenderer(e){const{useAntialiasing:t,physicalLights:s,meshMergeType:i}=e,o=new f({alpha:!0,antialias:t});o.setClearColor(0,0),o.outputEncoding=C,o.physicallyCorrectLights=s,o.toneMapping=v,this._container.append(o.domElement),this._renderer=o,this._renderMeshMergeType=i}resizeRenderer(e,t){this._renderer&&(this._renderer.setSize(e,t,!1),this.render())}updateRenderSceneAsync(){return U(this,void 0,void 0,(function*(){this._renderScene=null;const e=new l;if(e.add(...this._lights),this._renderGeometries.forEach(e=>e.geometry.dispose()),this._renderGeometries.length=0,this._renderGeometryIndexBySourceMesh.clear(),this._sourceMeshesByRenderGeometryIndex.clear(),this._renderMeshBySourceMesh.clear(),this._renderGeometryIndicesNeedSort.clear(),this._renderMeshMergeType){const t=yield this.groupModelMeshesByMergeType(this._loadedMeshesArray,this._loadedModelsArray,this._renderMeshMergeType);for(const e of t)if(e.length){const t=yield this.buildRenderGeometryAsync(e);this._renderGeometries.push(t);const s=this._renderGeometries.length-1;this._sourceMeshesByRenderGeometryIndex.set(s,e),this._renderGeometryIndicesNeedSort.add(s),e.forEach(e=>{this._renderGeometryIndexBySourceMesh.set(e,s)})}this._renderGeometries.forEach(t=>{const s=new c(t.geometry,this._colorRgbRmoUtils.globalMaterial);e.add(s)})}else this._loadedMeshesArray.forEach(t=>{const s=A.getFromMesh(t),i=this._colorRgbRmoUtils.getMaterial(s),o=new c(t.geometry,i);o.applyMatrix4(t.matrix),this._renderMeshBySourceMesh.set(t,o),e.add(o)});this._renderScene=e,this.render(this._loadedMeshesArray.length?[this._renderScene]:null)}))}groupModelMeshesByMergeType(e,t,s){return U(this,void 0,void 0,(function*(){let i;switch(s){case"scene":i=[e];break;case"model_uncapped":i=t.map(e=>e.meshes).filter(e=>e.length);break;case"model_capped":i=[];const s=1e3;t.map(e=>e.meshes).filter(e=>e.length).forEach(e=>{if(e.length<=s)i.push(e);else for(let t=0;t<e.length;t+=s){const o=e.slice(t,t+s);i.push(o)}});break;default:i=[]}return i}))}buildRenderGeometryAsync(e){return U(this,void 0,void 0,(function*(){let t=0,s=0;if(e.forEach(e=>{t+=3*e.geometry.getAttribute("position").count,s+=e.geometry.getIndex().count}),0===t)return;const i=new S(new Uint32Array(s),1),o=new w(new Float32Array(t),3),r=new w(new Float32Array(t),3),n=new w(new Float32Array(t),3),h=new Map;let a=0,l=0;for(let t=0;t<e.length;t+=100)yield new Promise(s=>{setTimeout(()=>{e.slice(t,t+100).forEach(e=>{const t=e.geometry.clone().applyMatrix4(e.matrix),s=t.getAttribute("position").array,d=t.getIndex().array,c=new Uint32Array(d.length);h.set(e,c);for(let e=0;e<d.length;e++){const t=d[e]+a;i.setX(l++,t),c[e]=t}for(let t=0;t<s.length;){const i=A.getFromMesh(e);o.setXYZ(a,i.r,i.g,i.b),r.setXYZ(a,i.roughness,i.metalness,i.opacity),n.setXYZ(a++,s[t++],s[t++],s[t++])}t.dispose()}),s()},0)});const d=new b;return d.setIndex(i),d.setAttribute("color",o),d.setAttribute("rmo",r),d.setAttribute("position",n),{geometry:d,positions:n,colors:o,rmos:r,indices:i,indicesBySourceMesh:h}}))}updateMeshRenderMaterials(){this._sourceMeshesNeedColorUpdate.forEach(e=>{const{rgbRmo:t}=this._colorRgbRmoUtils.refreshMeshColors(e),s=this._colorRgbRmoUtils.getMaterial(t);this._renderMeshBySourceMesh.get(e).material=s})}sortRenderGeometriesIndicesByOpacity(){this._renderGeometryIndicesNeedSort.forEach(e=>{const t=this._sourceMeshesByRenderGeometryIndex.get(e),s=[],i=[];t.forEach(e=>{1===A.getFromMesh(e).opacity?s.push(e):i.push(e)});const{indices:o,indicesBySourceMesh:r}=this._renderGeometries[e];let n=0;s.forEach(e=>{r.get(e).forEach(e=>{o.setX(n++,e)})}),i.forEach(e=>{r.get(e).forEach(e=>{o.setX(n++,e)})}),o.needsUpdate=!0})}updateRenderGeometriesColors(){const e=new Map;this._sourceMeshesNeedColorUpdate.forEach(t=>{const s=this._renderGeometryIndexBySourceMesh.get(t);e.has(s)?e.get(s).push(t):e.set(s,[t])}),e.forEach((e,t)=>{this.updateRenderGeometryColors(t,e)})}updateRenderGeometryColors(e,t){const{colors:s,rmos:i,indicesBySourceMesh:o}=this._renderGeometries[e];let r=!1;t.forEach(e=>{const{rgbRmo:t,opacityChanged:n}=this._colorRgbRmoUtils.refreshMeshColors(e);o.get(e).forEach(e=>{s.setXYZ(e,t.r,t.g,t.b),i.setXYZ(e,t.roughness,t.metalness,t.opacity)}),!r&&n&&(r=!0)}),s.needsUpdate=!0,i.needsUpdate=!0,r&&this._renderGeometryIndicesNeedSort.add(e)}render(e=null){this._renderScene&&((null==e?void 0:e.length)&&this._cameraControls.focusCameraOnObjects(e),this._sourceMeshesNeedColorUpdate.size&&(this._renderMeshMergeType?this.updateRenderGeometriesColors():this.updateMeshRenderMaterials(),this._sourceMeshesNeedColorUpdate.clear()),this._renderGeometryIndicesNeedSort.size&&(this.sortRenderGeometriesIndicesByOpacity(),this._renderGeometryIndicesNeedSort.clear()),requestAnimationFrame(()=>{this._renderer.render(this._renderScene,this._cameraControls.camera)}))}initLoader(e){const{dracoDecoderEnabled:t,dracoDecoderPath:s}=e,i=new E;if(t){const e=new L;e.setDecoderPath(s),e.preload(),i.setDRACOLoader(e)}this._loader=i,this.processLoadingQueueAsync()}processLoadingQueueAsync(){return U(this,void 0,void 0,(function*(){if(this._renderer&&this._loader&&!this._loadingInProgress){for(this._loadingInProgress=!0,this._loadingStateChange.next(!0);this._loadingQueue.length>0;){const e=this._loadingQueue.shift();yield e()}this.runQueuedColoring(),this.runQueuedSelection(),yield this.updateRenderSceneAsync(),this._loadingStateChange.next(!1),this._loadingInProgress=!1}}))}loadModel(e,t,s){return U(this,void 0,void 0,(function*(){let i;this.onModelLoadingStart(e,t);try{const i=yield this._loader.loadAsync(e,s=>this.onModelLoadingProgress(s,e,t));this.addModelToLoaded(i,t,s)}catch(e){i=e}const o={url:e,guid:t,error:i};return this.onModelLoadingEnd(o),o}))}onModelLoadingStart(e,t){this._modelLoadingStart.next({url:e,guid:t})}onModelLoadingProgress(e,t,s){const i=Math.round(e.loaded/e.total*100);this._modelLoadingProgress.next({url:t,guid:s,progress:i})}onModelLoadingEnd(e){const{url:t,guid:s}=e;this._modelLoadingProgress.next({url:t,guid:s,progress:0}),this._modelLoadingEnd.next(e)}addModelToLoaded(e,t,s){const i=s||t,o=e.scene;o.userData.guid=t,o.name=i;const r=[],n=new Set;o.traverse(e=>{if(e instanceof c&&e.geometry instanceof b&&e.material instanceof g){const s=`${t}|${e.name}`;e.userData.id=s,e.userData.modelGuid=t,this._pickingScene.add(e),this._loadedMeshes.add(e),this._loadedMeshesById.has(s)?this._loadedMeshesById.get(s).push(e):this._loadedMeshesById.set(s,[e]),r.push(e),n.add(e.name)}});const h={name:i,meshes:r,handles:n};this._loadedModels.add(h),this._loadedModelsByGuid.set(t,h),this.updateModelsDataArrays(),this.emitOpenedModelsChanged()}removeModelFromLoaded(e){if(!this._loadedModelsByGuid.has(e))return;const t=this._loadedModelsByGuid.get(e);t.meshes.forEach(e=>{var t;this._loadedMeshes.delete(e),this._loadedMeshesById.delete(e.userData.id),this._pickingScene.remove(e),null===(t=e.geometry)||void 0===t||t.dispose()}),this._highlightedMesh=null,this._selectedMeshes=this._selectedMeshes.filter(t=>t.userData.modelGuid!==e),this._isolatedMeshes=this._isolatedMeshes.filter(t=>t.userData.modelGuid!==e),this._coloredMeshes=this._coloredMeshes.filter(t=>t.userData.modelGuid!==e),this._loadedModels.delete(t),this._loadedModelsByGuid.delete(e),this.updateModelsDataArrays(),this.emitOpenedModelsChanged()}updateModelsDataArrays(){this._loadedMeshesArray=[...this._loadedMeshes],this._loadedModelsArray=[...this._loadedModels]}emitOpenedModelsChanged(){const e=[];for(const[t,s]of this._loadedModelsByGuid)e.push({guid:t,name:s.name,handles:s.handles});this._openedModelsChange.next(e)}runQueuedColoring(){this._queuedColoring&&this.resetSelectionAndColorMeshes(this._queuedColoring)}resetSelectionAndColorMeshes(e){this.removeIsolation(),this.removeSelection(),this.colorMeshes(e)}colorMeshes(e){if(this.removeColoring(),null==e?void 0:e.length)for(const t of e){const e=new o(t.color),s=new A(e.r,e.g,e.b,1,0,t.opacity);t.ids.forEach(e=>{const t=this._loadedMeshesById.get(e);(null==t?void 0:t.length)&&t.forEach(e=>{e.userData.colored=!0,A.setCustomToMesh(e,s),this._sourceMeshesNeedColorUpdate.add(e),this._coloredMeshes.push(e)})})}this.render()}removeColoring(){for(const e of this._coloredMeshes)e.userData.colored=void 0,A.deleteFromMesh(e,!0),this._sourceMeshesNeedColorUpdate.add(e);this._coloredMeshes.length=0}getMeshAt(e,t){return this._pickingScene?this._pickingScene.getMeshAt(this._cameraControls.camera,this._renderer,e,t):null}runQueuedSelection(){if(this._queuedSelection){const{ids:e,isolate:t}=this._queuedSelection;this.findAndSelectMeshes(e,t)}}findAndSelectMeshes(e,t){const{found:s}=this.findMeshesByIds(new Set(e));s.length&&this.selectMeshes(s,!1,t)}findMeshesByIds(e){const t=[],s=new Set;return e.forEach(e=>{this._loadedMeshesById.has(e)?t.push(...this._loadedMeshesById.get(e)):s.add(e)}),{found:t,notFound:s}}removeSelection(){for(const e of this._selectedMeshes)e.userData.selected=void 0,this._sourceMeshesNeedColorUpdate.add(e);this._selectedMeshes.length=0}removeIsolation(){for(const e of this._isolatedMeshes)e.userData.isolated=void 0,this._sourceMeshesNeedColorUpdate.add(e);this._isolatedMeshes.length=0}selectMeshAtPoint(e,t,s){const i=this.getMeshAt(e,t);i?s?i.userData.selected?this.removeFromSelection(i):this.addToSelection(i):this.selectMeshes([i],!0,!1):this.selectMeshes([],!0,!1)}addToSelection(e){const t=[e,...this._selectedMeshes];return this.selectMeshes(t,!0,!1),!0}removeFromSelection(e){const t=this._selectedMeshes.filter(t=>t!==e);return this.selectMeshes(t,!0,!1),!0}selectMeshes(e,t,s){if(this.removeSelection(),this.removeIsolation(),!(null==e?void 0:e.length))return this.emitSelectionChanged(t,!0),null;e.forEach(e=>{e.userData.selected=!0,this._sourceMeshesNeedColorUpdate.add(e)}),this._selectedMeshes=e,s?(this.emitSelectionChanged(t,!1),this.isolateSelectedMeshes()):this.emitSelectionChanged(t,!0)}isolateSelectedMeshes(){this._selectedMeshes.length&&(this._loadedMeshesArray.forEach(e=>{e.userData.selected||(e.userData.isolated=!0,this._sourceMeshesNeedColorUpdate.add(e),this._isolatedMeshes.push(e))}),this.render(this._selectedMeshes))}emitSelectionChanged(e,t){t&&this.render(e?null:this._selectedMeshes);const s=new Set;this._selectedMeshes.forEach(e=>s.add(e.userData.id)),this._selectionChange.next(s),e&&this._manualSelectionChange.next(s)}highlightMeshAtPoint(e,t){const s=this.getMeshAt(e,t);this.highlightItem(s)}highlightItem(e){e!==this._highlightedMesh&&(this.removeHighlighting(),e&&(e.userData.highlighted=!0,this._sourceMeshesNeedColorUpdate.add(e),this._highlightedMesh=e),this.render())}removeHighlighting(){if(this._highlightedMesh){const e=this._highlightedMesh;e.userData.highlighted=void 0,this._sourceMeshesNeedColorUpdate.add(e),this._highlightedMesh=null}}}export{F as GltfViewer,G as GltfViewerOptions};
